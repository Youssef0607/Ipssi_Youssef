#!/bin/bash

# ==============================================================================
# SCRIPT : SENTINEL MASTER v7.0
# ADMIN  : YOUSSEF | FIX : ALIGNMENT & NO-FLICKER
# ==============================================================================

export LANG=fr_FR.UTF-8
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
WHITE='\033[1;37m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

tput civis
trap "tput cnorm; clear; exit" SIGINT

LAST_MSG="Console Sentinel prête."
METEO=$(curl -s --connect-timeout 2 'wttr.in/Nice?format=%c+%t' 2>/dev/null || echo "☀️ +16°C")

# --- DESSIN DU CADRE FIXE ---
# --- DESSIN DU CADRE FIXE (CORRIGÉ) ---
draw_frame() {
    clear
    echo -e "${BLUE}┌─────────────────────────────────┬──────────────────────────────────┐${NC}"
    # Ligne Opérateur
    printf "${BLUE}│${NC}  ${YELLOW}OPERATOR : ${PURPLE}%-20s${NC} ${BLUE}│${NC}  ${CYAN}%-32s${NC}${BLUE}│\n" "youssef" "IPSSI SECURITY UNIT"
    
    # Logo IPSSI + TIME
    printf "${BLUE}│${NC}  ${CYAN}%-31s${NC}${BLUE}│${NC}  ${WHITE}TIME : %-25s${NC}${BLUE}│\n" "██╗██████╗ ███████╗███████╗██╗" ""
    printf "${BLUE}│${NC}  ${CYAN}%-31s${NC}${BLUE}│${NC}  ${WHITE}CITY : %-25s${NC}${BLUE}│\n" "██║██╔══██╗██╔════╝██╔════╝██║" "Nice, FR"
    printf "${BLUE}│${NC}  ${CYAN}%-31s${NC}${BLUE}│${NC}  ${WHITE}METEO: %-25s${NC}${BLUE}│\n" "██║██████╔╝███████╗███████╗██║" "$METEO"
    printf "${BLUE}│${NC}  ${CYAN}%-31s${NC}${BLUE}│${NC}  ${BLUE}%-32s${NC}${BLUE}│\n" "██║██╔═══╝ ╚════██║╚════██║██║" "──────────────────────────"
    printf "${BLUE}│${NC}  ${CYAN}%-31s${NC}${BLUE}│${NC}  ${YELLOW}HEALTH : %-23s${NC}${BLUE}│\n" "██║██║     ███████║███████║██║" ""
    printf "${BLUE}│${NC}  ${CYAN}%-31s${NC}${BLUE}│${NC}  ${GREEN}STATUS : %-23s${NC}${BLUE}│\n" "╚═╝╚═╝     ╚══════╝╚══════╝╚═╝" "ONLINE"

    echo -e "${BLUE}├─────────────────────────────────┼──────────────────────────────────┤${NC}"
    
    # Menu Sécurité / Système
    printf "${BLUE}│${NC}  ${WHITE}%-31s${NC}${BLUE}│${NC}  ${WHITE}%-32s${NC}${BLUE}│\n" "[ SÉCURITÉ ]" "[ SYSTÈME ]"
    printf "${BLUE}│${NC}  %-31s${BLUE}│${NC}  %-32s${BLUE}│\n" "1. Audit Security (CSV)" "4. Storage Analyzer"
    printf "${BLUE}│${NC}  %-31s${BLUE}│${NC}  %-32s${BLUE}│\n" "2. System Logs (Critical)" "5. Clean Temp Files"
    printf "${BLUE}│${NC}  %-31s${BLUE}│${NC}  %-32s${BLUE}│\n" "3. Open Ports Scan" "6. Top Process Alert"
    printf "${BLUE}│${NC}  %-31s${BLUE}│${NC}  %-32s${BLUE}│\n" "" ""

    echo -e "${BLUE}├─────────────────────────────────┼──────────────────────────────────┤${NC}"
    
    # Menu Réseau / Maintenance
    printf "${BLUE}│${NC}  ${WHITE}%-31s${NC}${BLUE}│${NC}  ${WHITE}%-32s${NC}${BLUE}│\n" "[ RÉSEAU & ADMIN ]" "[ MAINTENANCE ]"
    printf "${BLUE}│${NC}  %-31s${BLUE}│${NC}  %-32s${BLUE}│\n" "7. Network Diagnostic" "10. SMART BACKUP & HASH"
    printf "${BLUE}│${NC}  %-31s${BLUE}│${NC}  %-32s${BLUE}│\n" "8. User Provisioning" "11. MONITOR SERVICES"
    printf "${BLUE}│${NC}  %-31s${BLUE}│${NC}  %-32s${BLUE}│\n" "" ""
    printf "${BLUE}│${NC}  ${RED}%-31s${NC}${BLUE}│${NC}  %-32s${BLUE}│\n" "0. DISCONNECT (EXIT)" ""

    echo -e "${BLUE}├─────────────────────────────────┴──────────────────────────────────┤${NC}"
    
    # Info & Monitor
    printf "${BLUE}│${NC} ${WHITE}>> INFO : %-58s ${BLUE}│\n" ""
    echo -e "${BLUE}├────────────────────────────────────────────────────────────────────┤${NC}"
    printf "${BLUE}│${NC}  ${PURPLE}%-48s${NC} ${CYAN}%-15s${NC}${BLUE}│\n" "TOP PROCESS MONITOR (LIVE)" "[BY IPSSI]"
    printf "${BLUE}│${NC}  %-66s${BLUE}│\n" ""
    printf "${BLUE}│${NC}  %-66s${BLUE}│\n" ""
    printf "${BLUE}│${NC}  %-66s${BLUE}│\n" ""
    echo -e "${BLUE}└────────────────────────────────────────────────────────────────────┘${NC}"
}
